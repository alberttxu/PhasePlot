#!/bin/bash
SCRIPTDIR="$(cd "$(dirname "$0")"; pwd -P)"
INPUTFILE=$1

if [ ! -e ctffindoptions.txt ]; then
    echo "no ctffindoptions.txt file"
    exit 1
else
    CTFFIND_COMMAND=$(< ctffindoptions.txt)
    PLOT_COMMAND="$SCRIPTDIR/../lib/ctffindPlot.py *output.txt; "
    CLEANUP_COMMAND="rm -f *_output_avrot.txt *_output.txt"
fi

if [ "$INPUTFILE" ]; then
    BASENAME=${INPUTFILE%.mrc}
    OUTPUTFILE=${BASENAME}_output.txt
    CTFFIND_COMMAND=${CTFFIND_COMMAND//(filename)/$INPUTFILE}
    CTFFIND_COMMAND=${CTFFIND_COMMAND//(basename)/$BASENAME}
    eval "$CTFFIND_COMMAND"
    eval "$SCRIPTDIR/../lib/ctffindPlot.py $OUTPUTFILE; "
    eval "$CLEANUP_COMMAND"
else
    $SCRIPTDIR/../lib/moviewatcher/moviewatcher \
        -d done \
        -ext .mrc \
        -c <(echo "$CTFFIND_COMMAND"$'\n'"$PLOT_COMMAND"$'\n'"$CLEANUP_COMMAND")
fi
