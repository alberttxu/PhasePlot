#!/bin/bash
ALIGNED_DONE_DIR='alignedMRC'
CTF_FITS_DIR='ctf_fits'
OUTPUTPNG='ctf_plot.png'
LOGFILE='ctf_log.txt'
CTFFINDPARAMS='ctffindoptions.txt'

USAGEHELP='Usage: ctffindPlot [-h] [-o output_png] [-p aligned_mrc_dir] '
USAGEHELP+='[-t ctffind_params_file]  [-c ctf_fits_dir] [-l logfile]'

while getopts ':ho:p:t:c:l:' opt; do
  case "${opt}" in
    h) echo "$USAGEHELP" 1>&2
       exit 1
       ;;
    \?) echo "$USAGEHELP" 1>&2
       exit 1
       ;;
    o) OUTPUTPNG="$OPTARG"
       echo "output png: $OUTPUTPNG"
       ;;
    p) ALIGNED_DONE_DIR="$OPTARG"
       echo "aligned mrc directory: $ALIGNED_DONE_DIR"
       ;;
    t) CTFFINDPARAMS="$OPTARG"
       echo "ctffind parameters file: $CTFFINDPARAMS"
       ;;
    c) CTF_FITS_DIR="$OPTARG"
       echo "ctffind fitted mrc directory: $CTF_FITS_DIR"
       ;;
    l) LOGFILE="$OPTARG"
       echo "logfile: $LOGFILE"
       ;;
    :) echo "$OPTARG option is missing an argument"
       exit 1
       ;;
  esac
done

if [ ! -f $CTFFINDPARAMS ]; then
    echo "$CTFFINDPARAMS not found"
    exit
fi

if [ ! -d $CTF_FITS_DIR ]; then
    echo "creating $CTF_FITS_DIR"
    mkdir $CTF_FITS_DIR
fi

SCRIPTDIR="$(cd "$(dirname "$0")"; pwd -P)"
CTFFIND_COMMAND=$(< "$CTFFINDPARAMS")
PLOT_COMMAND="$SCRIPTDIR/../lib/ctffindPlot.py --input (basename)_ali_output.txt "
PLOT_COMMAND+="--output $OUTPUTPNG --log $LOGFILE; "
CLEANUP_COMMAND="rm -f (basename)_ali_output_avrot.txt (basename)_ali_output.txt; "
CLEANUP_COMMAND+="mv (basename)_ali_output.mrc $CTF_FITS_DIR"

shift "$((OPTIND-1))"
INPUTFILE="$1"
if [ "$INPUTFILE" ]; then # process single file
    BASENAME=${INPUTFILE%_ali.mrc}
    CTFFIND_COMMAND=${CTFFIND_COMMAND//(filename)/$INPUTFILE}
    CTFFIND_COMMAND=${CTFFIND_COMMAND//(basename)/$BASENAME}
    PLOT_COMMAND=${PLOT_COMMAND//(basename)/$BASENAME}
    CLEANUP_COMMAND=${CLEANUP_COMMAND//(basename)/$BASENAME}
    echo "$CTFFIND_COMMAND"
    echo "$PLOT_COMMAND"
    echo "$CLEANUP_COMMAND"
    eval "$CTFFIND_COMMAND"
    eval "$PLOT_COMMAND"
    eval "$CLEANUP_COMMAND"

else # watching mode
    $SCRIPTDIR/../lib/moviewatcher/moviewatcher \
        -d "$ALIGNED_DONE_DIR" \
        -ext _ali.mrc \
        -c <(echo "$CTFFIND_COMMAND"$'\n'"$PLOT_COMMAND"$'\n'"$CLEANUP_COMMAND")
fi
