#!/bin/bash
SCRIPTDIR="$(cd "$(dirname "$0")"; pwd -P)"
INPUTFILE=$1

if [ ! -e ctffindoptions.txt ]; then
    echo "no ctffindoptions.txt file"
    exit 1
else
    if [ ! -d ctf_fits ]; then
        mkdir ctf_fits
    fi
    CTFFIND_COMMAND=$(< ctffindoptions.txt)
    PLOT_COMMAND="$SCRIPTDIR/../lib/ctffindPlot.py (basename)_ali_output.txt; "
fi

if [ "$INPUTFILE" ]; then
    BASENAME=${INPUTFILE%_ali.mrc}
    OUTPUTFILE=${BASENAME}_ali_output.txt
    CTFFIND_COMMAND=${CTFFIND_COMMAND//(filename)/$INPUTFILE}
    CTFFIND_COMMAND=${CTFFIND_COMMAND//(basename)/$BASENAME}
    PLOT_COMMAND=${PLOT_COMMAND//(basename)/$BASENAME}
    CLEANUP_COMMAND="rm -f ${BASENAME}_ali_output_avrot.txt ${BASENAME}_ali_output.txt; "
    CLEANUP_COMMAND+="mv ${BASENAME}_ali_output.mrc ctf_fits"
    echo "$CTFFIND_COMMAND"
    echo "$SCRIPTDIR/../lib/ctffindPlot.py $OUTPUTFILE; "
    echo "$CLEANUP_COMMAND"
    eval "$CTFFIND_COMMAND"
    eval "$SCRIPTDIR/../lib/ctffindPlot.py $OUTPUTFILE; "
    eval "$CLEANUP_COMMAND"
else
    CLEANUP_COMMAND="rm -f (basename)_ali_output_avrot.txt (basename)_ali_output.txt; "
    CLEANUP_COMMAND+="mv (basename)_ali_output.mrc ctf_fits"
    $SCRIPTDIR/../lib/moviewatcher/moviewatcher \
        -d done \
        -ext _ali.mrc \
        -c <(echo "$CTFFIND_COMMAND"$'\n'"$PLOT_COMMAND"$'\n'"$CLEANUP_COMMAND")
fi
